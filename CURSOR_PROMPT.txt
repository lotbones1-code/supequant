ðŸŽ¯ PASTE THIS ENTIRE TEXT INTO CURSOR FOR V3 IMPLEMENTATION
========================================================================

You are implementing BreakoutV3 strategy to improve trading performance from -1.14% to +2.5-3.0%.

Current problem: Strategy generates 30% win rate with 0.87 profit factor due to whipsaw exits.
Solution: 4 improvements addressing false breakouts and premature exits.

---

TASK 1: Create strategy/breakout_strategy_v3.py

Base it on strategy/breakout_strategy_v2.py but add 4 improvements:

Improvment 1 - Pullback Confirmation (eliminates false breakouts):
- Before entering long: Check if resistance level was tested in previous 2 candles
  - If candles[-3] or candles[-2] high >= breakout_level * 0.995: SKIP (already tested)
- Before entering short: Check if support level was tested in previous 2 candles
  - If candles[-3] or candles[-2] low <= breakout_level * 1.005: SKIP (already tested)
- Add method: _detect_pullback_confirmation(self, candles, breakout_level, direction) -> bool
- Call this in analyze() method after detecting breakout
- Log when confirmation passes/fails

Improvement 2 - Dynamic Stop Loss (prevents stops on pullbacks):
- Calculate stop multiplier based on volume_ratio:
  - volume_ratio > 3.5: return 1.2x ATR (strong volume, tight stops)
  - volume_ratio 2.5-3.5: return 1.5x ATR (medium, default)
  - volume_ratio < 2.5: return 2.0x ATR (weak, wide stops)
- Add method: _calculate_dynamic_stop_multiplier(self, volume_ratio) -> float
- Use this in _generate_signal() instead of hard-coded 1.5x
- Log the chosen multiplier

Improvement 3 - Progressive Profit-Taking (lock profits, reduce reversals):
- Modify _generate_signal() to add 3 take-profit levels instead of 2:
  - tp1 = entry_price (breakeven, exit 50%)
  - tp2 = entry_price + (risk * 1.5) [for long] or entry_price - (risk * 1.5) [for short]
  - tp3 = entry_price + (risk * 3.0) [for long] or entry_price - (risk * 3.0) [for short]
- Add to signal dict: 
  - 'take_profit_1', 'take_profit_2', 'take_profit_3'
  - 'position_split': {1: 0.5, 2: 0.3, 3: 0.2}  (exit 50%, 30%, 20%)
- Log all 3 TP levels

Improvement 4 - Stricter Volume:
- Change volume check from 2.0x to 2.5x minimum
- Line change in analyze(): if volume_ratio < 2.5: return None

Class structure:
- class BreakoutStrategyV3:
- self.name = "BreakoutV3"
- Same analyze() method signature as V2
- Keep all V2 logic, just add the 4 improvements above
- Keep same logging style with emojis

---

TASK 2: Update strategy/strategy_manager.py

1. Add import after line 6:
   from .breakout_strategy_v3 import BreakoutStrategyV3

2. In __init__ (line ~18), update strategies dict to:
   self.strategies = {
       'breakout_v2': BreakoutStrategyV2(),
       'breakout_v3': BreakoutStrategyV3(),
       'pullback': PullbackStrategy()
   }

3. In _select_best_signal method, prefer V3:
   - Check for 'v3' in strategy name first
   - Then check for 'v2'
   - Then others

---

TASK 3: Create backtest_v3_comparison.sh (optional)

Bash script to run backtest with V3:
#!/bin/bash
echo "ðŸ”„ BACKTEST V3 STRATEGY"
echo "====================================="
python backtest.py --symbol SOLUSDT --start-date 2025-12-15 --end-date 2026-01-14
echo "âœ… Backtest complete. Check reports in backtesting/reports/"

---

After creating files:

1. Test imports:
   python -c "from strategy.breakout_strategy_v3 import BreakoutStrategyV3; print(BreakoutStrategyV3().name)"
   Expected output: BreakoutV3

2. Run backtest:
   python backtest.py --symbol SOLUSDT --start-date 2025-12-15 --end-date 2026-01-14

3. Check results for improvements:
   - Win rate should go from 30% to 50%+
   - Profit factor from 0.87 to 1.3+
   - Drawdown from 4.22% to 2.5% or less
   - Total return from -1.14% to +1.5%+ 

4. Review logs for the 4 improvements:
   - Pullback confirmation: "Pullback: Resistance NOT previously tested"
   - Dynamic stops: "Strong volume / Medium volume / Weak volume"
   - Progressive TP: All 3 TP levels should be logged
   - Volume filter: No trades with volume_ratio < 2.5

If any improvement shows issues, check logs and debug that specific method.

---

Key file references from your codebase:
- Current V2: strategy/breakout_strategy_v2.py (use as template)
- Manager: strategy/strategy_manager.py (import and add V3)
- Backtest command: python backtest.py --symbol SOLUSDT --start-date 2025-12-15 --end-date 2026-01-14
- Reports: backtesting/reports/backtest_report_*.txt

---

Success criteria:
âœ… V3 file created with all 4 improvements
âœ… Strategy manager imports and uses V3
âœ… Backtest runs without errors
âœ… Logs show all 4 improvements working
âœ… Win rate >= 50% (up from 30%)
âœ… Profit factor >= 1.3 (up from 0.87)
âœ… Max drawdown <= 2.5% (down from 4.22%)

If everything passes, create PR: feature/v3-strategy-improvements â†’ main

========================================================================
